# .github/workflows/release.yml

name: Publish Ruby Gem

# This workflow runs when:
on:
  push:
    branches:
      - main # Run tests and build on every push to main
  # Run the build and release steps ONLY when a new tag is pushed (e.g., v0.1.0)
  release:
    types: [published]

jobs:
  test:
    name: Run Tests & Build Gem
    runs-on: ubuntu-latest
    
    # Use a matrix to test across common Ruby versions (e.g., 3.0, 3.1, 3.2, 3.3)
    strategy:
      matrix:
        ruby: ['3.1', '3.2', '3.3']

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true # Installs dependencies from Gemfile.lock

    - name: Run Tests with SimpleCov
      run: bundle exec rake test

    - name: Upload Test Coverage Report (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.ruby }}
        path: coverage/

    # Only build the .gem file on the latest stable Ruby version
    - name: Build Gem
      if: matrix.ruby == '3.3'
      run: bundle exec rake build

    - name: Upload Gem Artifact
      if: matrix.ruby == '3.3'
      uses: actions/upload-artifact@v4
      with:
        name: dlinked-gem
        path: pkg/
  deploy_docs:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: test # Ensure tests pass before deploying docs
    
    # Run only when pushing to the main branch
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write # Needed to push generated documentation to gh-pages branch

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true
          
      - name: Install YARD (if not in Gemfile)
        run: gem install yard
        
      - name: Generate YARD Documentation
        run: yard doc
        
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          # This is the authentication token provided by GitHub
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # The branch where YARD documentation will be pushed
          publish_branch: gh-pages 
          # The directory to publish (generated by yard doc)
          publish_dir: ./doc
  publish:
    name: Publish to RubyGems (OIDC)
    runs-on: ubuntu-latest
    needs: test # Ensure tests and build pass
    
    # This job ONLY runs when a release is published
    if: github.event_name == 'release' && github.event.action == 'published'
    
    # --- CRITICAL PERMISSIONS FOR OIDC ---
    permissions:
      contents: read # Read repo contents
      id-token: write # REQUIRED for OIDC authentication
    # ------------------------------------

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # This setting is required for some CI/CD flows, include it to be safe
          persist-credentials: false
          
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true 

      # We no longer need to download the artifact because we will rebuild it.
      # The release-gem action often handles the build itself, but let's
      # stick to the flow of building it explicitly just before.

      - name: Install Dependencies for Build
        run: bundle install

      - name: Build Gem (Ensure latest version)
        run: bundle exec rake build

      # --- USE THE OFFICIAL OIDC RELEASE ACTION ---
      - name: Publish Gem to RubyGems.org via OIDC
        uses: rubygems/release-gem@v1
        # The gem push command is handled internally by this action